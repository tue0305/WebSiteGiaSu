link(rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css' integrity='sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T' crossorigin='anonymous')
script(src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js')
script(src='//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js')
script(src='/javascripts/cubejs-client-core.umd.js')
#app.container
  .row
    .col-md-4
      .card
        .card-body
          h5.card-title Total Tweets
          .card-text
            h3#total-tweets
    .col-md-4
      .card
        .card-body
          h5.card-title Total Retweets
          .card-text
            h3#total-retweets
    .col-md-4
      .card
        .card-body
          h5.card-title Total Favorites
          .card-text
            h3#total-favorites
  br
  br
  .row
    .col-md-6
      .card
        .card-body
          h5.card-title Top Tweets Locations
          .card-text
            canvas#pie-chart
    .col-md-6
      .card
        .card-body
          h5.card-title Most Popular Languages
          .card-text
            canvas#bar-chart
script.
  var cubejsApi = cubejs(
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1NTIzOTk5MjcsImV4cCI6MTU1MjQ4NjMyN30.SOO-A6GfGH7ar3EoeBb0cjj10BVxO3ffjvmqQziXIZA',
  { apiUrl: 'http://localhost:3000/cubejs-api/v1' }
  );
  var kpis = [
  { measure: "Tweets.count", element: "total-tweets" },
  { measure: "Tweets.retweetCount", element: "total-retweets" },
  { measure: "Tweets.favoriteCount", element: "total-favorites" }
  ];
  kpis.forEach(kpi => {
  cubejsApi.load({
  measures: [kpi.measure]
  }).then(resultSet => {
  document.getElementById(kpi.element).textContent =
  numeral(resultSet.totalRow()[kpi.measure]).format('0,0');
  })
  });
  // A helper method to format data for Chart.js
  // and add some nice colors
  var chartJsData = function(resultSet) {
  return {
  datasets: [{
  data: resultSet.series()[0].series.map(function(r) { return r.value }),
  backgroundColor: [
  'rgb(255, 99, 132)',
  'rgb(255, 159, 64)',
  'rgb(255, 205, 86)',
  'rgb(75, 192, 192)',
  'rgb(54, 162, 235)'
  ]
  }],
  labels: resultSet.categories().map(function(c) { return c.category })
  }
  }
  cubejsApi.load({
  measures: ["Tweets.count"],
  dimensions: ["Tweets.location"],
  filters: [
  {
  dimension: "Tweets.location",
  operator: "notEquals",
  values: [""]
  }
  ],
  limit: 5
  }).then(resultSet => {
  new Chart(document.getElementById("pie-chart"), {
  type: 'pie',
  data: chartJsData(resultSet)
  })
  });
  cubejsApi.load({
  measures: ["Tweets.count"],
  dimensions: ["Tweets.lang"],
  limit: 5
  }).then(resultSet => {
  new Chart(document.getElementById("bar-chart"), {
  type: 'bar',
  data: chartJsData(resultSet),
  options: { legend: { display: false } }
  })
  });
